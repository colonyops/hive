version: "3"

env:
  HIVE_LOG_LEVEL: "debug"
  HIVE_LOG_FILE: "./dev.log"
  HIVE_CONFIG: "./config.dev.yaml"
  HIVE_DATA_DIR: "./.data"

tasks:
  run:
    desc: Runs the main application and supports passing CLI args
    cmds:
      - go run *.go {{ .CLI_ARGS }}
    silent: false

  build:
    desc: Builds the backend binary
    cmds:
      - goreleaser build --snapshot --clean

  sqlc:generate:
    desc: Generates Go code from SQL queries using sqlc
    dir: internal/store/sqlite
    cmds:
      - sqlc generate

  enum:generate:
    desc: Generates enum methods using go-enum (only runs if source files changed)
    sources:
      - internal/core/session/session.go
      - internal/core/terminal/terminal.go
      - internal/core/notify/store.go
      - internal/core/doctor/doctor.go
      - internal/tui/view.go
      - internal/tui/keybindings.go
      - internal/tui/model.go
      - internal/tui/command/service.go
      - internal/tui/views/review/review_document.go
      - internal/tui/views/review/review_finalize_modal.go
    generates:
      - internal/core/session/session_enum.go
      - internal/core/terminal/terminal_enum.go
      - internal/core/notify/store_enum.go
      - internal/core/doctor/doctor_enum.go
      - internal/tui/view_enum.go
      - internal/tui/keybindings_enum.go
      - internal/tui/model_enum.go
      - internal/tui/command/service_enum.go
      - internal/tui/views/review/review_document_enum.go
      - internal/tui/views/review/review_finalize_modal_enum.go
    cmds:
      - >
        go-enum --nocase --names --marshal
        -f internal/core/session/session.go
        -f internal/core/terminal/terminal.go
        -f internal/core/notify/store.go
        -f internal/core/doctor/doctor.go
        -f internal/tui/view.go
        -f internal/tui/keybindings.go
        -f internal/tui/model.go
        -f internal/tui/command/service.go
        -f internal/tui/views/review/review_document.go
        -f internal/tui/views/review/review_finalize_modal.go

  test:
    desc: Runs all go tests using gotestsum - supports passing gotestsum args
    cmds:
      - gotestsum {{ .CLI_ARGS }} ./...

  test:watch:
    desc: Runs all go tests using gotestsum in watch mode
    cmds:
      - gotestsum --watch -- -v ./...

  coverage:
    desc: Runs all go tests with -race flag and generates a coverage report
    cmds:
      - go test -race -coverprofile=coverage.out -covermode=atomic ./... -v -cover
    silent: true

  tidy:
    desc: Runs go mod tidy on the backend
    cmds:
      - go mod tidy

  lint:
    desc: Runs golangci-lint
    cmds:
      - golangci-lint run ./...

  fmt:
    desc: Runs golangci-lint fmt on the backend
    cmds:
      - golangci-lint fmt ./...

  check:
    desc: Runs all go test and lint related tasks
    cmds:
      - task: enum:generate
      - task: tidy
      - task: lint
      - task: test

  validate:
    desc: Runs config validate command
    cmds:
      - go run *.go config validate

  validate:invalid:
    desc: Runs config validate with an intentionally invalid config to test error output
    env:
      HIVE_CONFIG: "./config.invalid.yaml"
    cmds:
      - go run *.go config validate || true
