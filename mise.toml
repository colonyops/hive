[tools]
"go:github.com/abice/go-enum" = "v0.9.2"
"github:hay-kot/gobusgen" = "v0.3.0"
"github:sqlc-dev/sqlc" = "v1.30.0"
"go" = "1.26"
"pipx:zensical" = "latest"
golangci-lint = "v2.9.0"

[env]
HIVE_LOG_LEVEL = "debug"
HIVE_LOG_FILE = "./dev.log"

[tasks."generate:enums"]
description = "Generate enum methods using go-enum"
sources = ["internal/core/action/type.go"]
outputs = ["internal/core/action/type_enum.go"]
run = "go-enum --nocase --names --marshal -f internal/core/action/type.go"

[tasks.generate]
description = "Run all code generators"
depends = ["generate:enums"]
sources = [
  "internal/core/eventbus/events.go",
  "internal/data/db/queries/queries.sql",
  "internal/data/db/schema/schema.sql",
  "sqlc.yaml",
]
outputs = [
  "internal/core/eventbus/eventbus.gen.go",
  "internal/data/db/db.go",
  "internal/data/db/models.go",
  "internal/data/db/queries.sql.go",
]
run = ["go generate ./...", "sqlc generate"]

[tasks.start]
alias = "default"
description = "Run hive with global config (supports CLI args)"
depends = ["generate"]
run = "go run *.go"

[tasks.dev]
description = "Run hive with dev config (supports CLI args)"
depends = ["generate"]
env = { HIVE_LOG_LEVEL = "debug", HIVE_LOG_FILE = "./dev.log", HIVE_CONFIG = "./config.dev.yaml", HIVE_DATA_DIR = "./.data" }
run = "go run *.go"

[tasks.build]
description = "Build with goreleaser"
depends = ["generate"]
run = "goreleaser build --snapshot --clean"

[tasks.test]
description = "Run all go tests"
run = "go test ./..."

[tasks.coverage]
description = "Run tests with race detection and coverage"
quiet = true
run = "go test -race -coverprofile=coverage.out -covermode=atomic ./... -v -cover"

[tasks.lint]
description = "Run golangci-lint"
run = "golangci-lint run ./..."

[tasks.fmt]
description = "Run golangci-lint fmt"
run = "golangci-lint fmt ./..."

[tasks.check]
description = "Run tidy, lint, and test"
run = ["go mod tidy", { tasks = ["lint", "test"] }]

[tasks.validate]
description = "Run doctor with dev config"
env = { HIVE_CONFIG = "./config.dev.yaml" }
run = "go run *.go doctor"

[tasks."validate:invalid"]
description = "Run doctor with intentionally invalid config"
env = { HIVE_CONFIG = "./config.invalid.yaml" }
run = "go run *.go doctor || true"

[tasks."docs:serve"]
description = "Serve documentation site locally"
run = "zensical serve"

[tasks."docs:build"]
description = "Build documentation site with llms.txt"
run = ["zensical build", "./scripts/generate-llmstxt.sh"]
